'use strict';var _createClass=function(){function a(b,d){for(var g,f=0;f<d.length;f++)g=d[f],g.enumerable=g.enumerable||!1,g.configurable=!0,'value'in g&&(g.writable=!0),Object.defineProperty(b,g.key,g)}return function(b,d,f){return d&&a(b.prototype,d),f&&a(b,f),b}}();function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var $=function(a){return document.getElementById(a)},canvasFabric=null,Img=function(){function a(){_classCallCheck(this,a),this.width=0,this.height=0,this.image=null,this.cvs=$('cvs'),this.ctx=this.cvs.getContext('2d'),this.canvasFabric=null,this.defaultHatImg=$('hat6'),this.detectResult=[],this.activeHat=null,this.exportImageContainer=$('export'),this.init=this.init.bind(this),this.changeHat=this.changeHat.bind(this),this.export=this.export.bind(this),this.setStep(1)}return _createClass(a,[{key:'vaildExtension',value:function vaildExtension(b){var f=b.name;return new RegExp('('+['.jpg','.jpeg','.bmp','.gif','.png'].join('|').replace(/\./g,'\\.')+')$').test(f)}},{key:'init',value:function init(b,d){var f=this;return this.vaildExtension(b)?void(this.setStep(2),this.image=new Image,this.image.src=d,this.image.onload=function(){var j=0,k=0,_image=f.image,g=_image.naturalWidth,h=_image.naturalHeight;g>h?(k=Math.min(window.screen.width,500),j=h/g*k):(j=Math.min(window.screen.width,500),k=g/h*j),f.width=k,f.height=j,f.image.width=k,f.image.height=j,f.cvs.width=k,f.cvs.height=j,f.detectFace(),f.convertImg2Cvs(f.image)}):void alert('\u8BF7\u4E0A\u4F20\u56FE\u7247\u683C\u5F0F\u7684\u6587\u4EF6')}},{key:'detectFace',value:function detectFace(){var b=this.width,d=this.height;this.ctx.drawImage(this.image,0,0,b,d);var f=this.ctx.getImageData(0,0,b,d).data,g={pixels:this.rgba_to_grayscale(f,b,d),nrows:d,ncols:b,ldim:b},j=pico.run_cascade(g,facefinder_classify_region,{shiftfactor:0.1,minsize:20,maxsize:1e3,scalefactor:1.1});j=pico.cluster_detections(j,0.2),console.log(j);this.detectResult=j.filter(function(l){return l[3]>5})}},{key:'rgba_to_grayscale',value:function rgba_to_grayscale(b,d,f){for(var g=new Uint8Array(d*f),h=0;h<d;++h)for(var j=0;j<f;++j)g[h*f+j]=(2*b[4*h*f+4*j+0]+7*b[4*h*f+4*j+1]+1*b[4*h*f+4*j+2])/10;return g}},{key:'convertImg2Cvs',value:function convertImg2Cvs(b){var l=this,d=this.width,f=this.height,g=this.defaultHatImg,h=this.detectResult;this.canvasFabric&&this.canvasFabric.dispose();var j=b.naturalWidth,k=b.naturalHeight;this.canvasFabric=new fabric.Canvas(this.cvs,{width:d,height:f,backgroundImage:new fabric.Image(b,{width:j,height:k,scaleX:d/j,scaleY:f/k})}),this.canvasFabric.on('mouse:down',function(m){m.target?(l.activeHat=l.canvasFabric.getActiveObject(),$('delete').style.display='block'):(l.activeHat=null,$('delete').style.display='none')}),this.canvasFabric.on('after:render',function(){console.log('rendered'),this.calcOffset()}),h.forEach(function(m){var n=m[2]/g.width,o=m[0]-g.height*n,p=m[1]-g.width*n/2,q=new Hat(g,o,p,n);l.canvasFabric.add(q)}),this.canvasFabric.requestRenderAll()}},{key:'addHat',value:function addHat(b){var d=this.width,f=this.height,g=this.defaultHatImg,h=new Hat(b||g,f/2-25,d/2-25,1);h&&(this.canvasFabric.add(h),this.canvasFabric.setActiveObject(h),this.activeHat=h,$('delete').style.display='block')}},{key:'changeHat',value:function changeHat(b){this.activeHat?this.activeHat.setElement(b):this.addHat(b),this.canvasFabric.requestRenderAll()}},{key:'removeHat',value:function removeHat(b){b&&this.canvasFabric.remove(b),$('delete').style.display='none',this.activeHat=null}},{key:'export',value:function _export(){this.setStep(3);var b=this.exportImageContainer,d=this.width,f=this.height;b.src=this.canvasFabric.toDataURL({format:'png',width:d,height:f,quality:1,multiplier:0.5}),this.canvasFabric&&this.canvasFabric.dispose(),this.canvasFabric=null}},{key:'tip',value:function tip(b){$('tip').innerHTML=b}},{key:'setStep',value:function setStep(b){switch(b){case 1:$('header').style.display='flex',$('hatsContainer').style.display='none',$('uploadContainer').style.display='flex',$('upload').style.display='block',$('footer').style.display='none',$('export').style.display='none',$('exportBtn').style.display='block',this.cvs.style.display='none',this.tip('');break;case 2:$('header').style.display='none',$('hatsContainer').style.display='flex',$('uploadContainer').style.display='none',$('upload').style.display='none',$('footer').style.display='flex',$('export').style.display='none',$('exportBtn').style.display='block',this.cvs.style.display='block',this.tip('');break;case 3:$('delete').style.display='none',$('hatsContainer').style.display='none',$('exportBtn').style.display='none',this.tip('\u957F\u6309\u56FE\u7247\u4FDD\u5B58\u6216\u5206\u4EAB'),this.cvs.style.display='none',this.exportImageContainer.style.display='block';break;default:}}}]),a}(),Hat=function a(b,d,f){var g=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1;if(_classCallCheck(this,a),!b||!d||!f)return null;var h=new fabric.Image(b,{top:d,left:f,width:b.naturalWidth,height:b.naturalHeight,scaleX:g,scaleY:g,centeredScaling:!0,cornerColor:'#0b3a42',cornerStrokeColor:'#fff',cornerStyle:'circle',transparentCorners:!1,rotatingPointOffset:30});return h.setControlsVisibility({bl:!1,tr:!1,tl:!1,ml:!1,mt:!1}),h.factor=g,h},img=new Img;$('reuploadImg').addEventListener('click',function(){$('upload').click()}),$('upload').addEventListener('change',function(){var a=$('upload').files[0];if(a){var b=new FileReader;b.readAsDataURL(a),b.onload=function(){img.init(a,b.result)}}}),$('delete').addEventListener('click',function(){img.removeHat(img.activeHat)}),$('hatsContainer').addEventListener('click',function(a){img.changeHat(a.target||a.srcElement)}),$('exportBtn').addEventListener('click',function(){img.export()});var facefinder_classify_region=function(){return-1},cascadeurl='//lqs469.coding.me/santa-cap/lib/facefinder';fetch(cascadeurl).then(function(a){a.arrayBuffer().then(function(b){var d=new Int8Array(b);facefinder_classify_region=pico.unpack_cascade(d),console.log('* cascade loaded'),$('overlay').style.display='none'})}),document.onreadystatechange=function(){'complete'===document.readyState&&($('cnzz_stat_icon_1275757193').style.display='none')};
